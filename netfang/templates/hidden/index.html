{% extends "hidden/hidden_structure.html" %}

{% block title %}NetFang Secured Router{% endblock %}

{% block header_title %}NetFang Secured Router - {{ hostname }}{% endblock %}

{% block main_content %}
    <div class="state-indicator">
        <strong>NetFang Status:</strong>
        <span id="state">{{ state }}</span>
        <div id="scanningIndicator" class="scanning-indicator">
            <div class="scanning-pulse"></div>
            <span>Scanning network...</span>
        </div>
        <div class="state-status-bar">
            <div class="state-status-progress"></div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <!-- Network Information -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2>Networks</h2>
                <span class="panel-toggle">▼</span>
            </div>
            <div class="panel-content">
                <div class="table-container">
                    <table class="data-table" id="networksTable">
                        <thead>
                            <tr>
                                <th>MAC Address</th>
                                <th>Status</th>
                                <th>Last Seen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Devices Information -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2>Devices</h2>
                <span class="panel-toggle">▼</span>
            </div>
            <div class="panel-content">
                <div class="table-container">
                    <table class="data-table" id="devicesTable">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>Vendor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Plugin Logs -->
        <div class="dashboard-panel">
            <div class="panel-header">
                <h2>Plugin Logs</h2>
                <span class="panel-toggle collapsed">▼</span>
            </div>
            <div class="panel-content collapsed">
                <div class="table-container">
                    <table class="data-table" id="pluginLogsTable">
                        <thead>
                            <tr>
                                <th>Plugin</th>
                                <th>Event</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-controls">
        <button id="syncButton" class="sync-button">Sync Dashboard</button>
        <button id="restartServiceButton" class="service-button">Restart Netfang Service</button>
        <div id="statusMessage" class="status-message"></div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    const stateElement = document.getElementById("state");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const stateIndicator = document.querySelector(".state-indicator");
    const stateStatusProgress = document.querySelector(".state-status-progress");
    let previousState = '{{ state }}';
    let currentIntervalID = null;

    // Update the state status progress based on current state
    function updateStateIndicator(state) {
        // Remove any existing state classes
        stateIndicator.className = "state-indicator";
        
        // Add the new state class
        stateIndicator.classList.add(`state-${state.replace(/\s+/g, '_')}`);
        
        // Update progress bar visibility based on state
        if (state.includes("SCANNING") || state.includes("CONNECTING")) {
            scanningIndicator.classList.add('active');
        } else {
            scanningIndicator.classList.remove('active');
        }
    }

    // Initialize collapsible panels
    document.querySelectorAll('.panel-header').forEach(header => {
        header.addEventListener('click', () => {
            const toggle = header.querySelector('.panel-toggle');
            const content = header.nextElementSibling;
            
            toggle.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        });
    });

    // Typewriter effect for 'state'
    function typeText(element, text) {
        if (currentIntervalID !== null) {
            clearInterval(currentIntervalID);
        }
        let index = 0;
        element.innerText = '';
        currentIntervalID = setInterval(() => {
            if (index < text.length) {
                element.innerText += text.charAt(index);
                index++;
            } else {
                clearInterval(currentIntervalID);
                currentIntervalID = null;
            }
        }, 50);
    }

    // Listen for state updates from the server
    socket.on("state_update", (data) => {
        console.log(`[${new Date().toLocaleTimeString()}] State update received:`, data);
        const newState = data.state || 'Unknown';

        if (newState !== previousState) {
            previousState = newState;
            typeText(stateElement, newState);
            updateStateIndicator(newState);
            
            // Show state change notification
            alertify.success(`State changed to: ${newState}`, 3);
        }
    });

    // Check initial state for scanning and update indicator
    updateStateIndicator(previousState);

    // Dashboard Data Management
    (function() {
        // Get DOM elements
        const networksTable = document.getElementById('networksTable').getElementsByTagName('tbody')[0];
        const devicesTable = document.getElementById('devicesTable').getElementsByTagName('tbody')[0];
        const pluginLogsTable = document.getElementById('pluginLogsTable').getElementsByTagName('tbody')[0];
        const syncButton = document.getElementById('syncButton');
        const restartServiceButton = document.getElementById('restartServiceButton');
        const statusMessage = document.getElementById('statusMessage');
        
        // Format timestamp for display
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return 'Invalid time';
            }
        }
        
        // Toggle fingerprint display
        function setupFingerprintToggles() {
            document.querySelectorAll('.show-fingerprint').forEach(button => {
                button.addEventListener('click', function() {
                    const dataElement = this.nextElementSibling;
                    if (dataElement.style.display === 'block') {
                        dataElement.style.display = 'none';
                        this.textContent = 'Show Fingerprint';
                    } else {
                        dataElement.style.display = 'block';
                        this.textContent = 'Hide Fingerprint';
                    }
                });
            });
        }
        
        // Handle dashboard data sync
        function updateDashboardData(data) {
            // Clear existing tables
            networksTable.innerHTML = '';
            devicesTable.innerHTML = '';
            pluginLogsTable.innerHTML = '';
            
            // Populate Networks table
            data.networks.forEach(network => {
                const row = networksTable.insertRow();
                
                const statusClass = network.is_home ? 'network-home' : 
                                   (network.is_blacklisted ? 'network-blacklisted' : '');
                
                const statusText = network.is_home ? 'Home' : 
                                  (network.is_blacklisted ? 'Blacklisted' : 'Known');
                
                row.innerHTML = `
                    <td>${network.mac_address}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${formatTimestamp(network.last_seen)}</td>
                `;
            });
            
            // Populate Devices table
            data.devices.forEach(device => {
                const row = devicesTable.insertRow();
                
                // Check if we have fingerprint data
                const hasFingerprintData = device.fingerprint && device.fingerprint !== 'None';
                const fingerprintHtml = hasFingerprintData ? 
                    `<span class="show-fingerprint">Show Fingerprint</span>
                     <div class="fingerprint-data">${device.fingerprint}</div>` : '';
                
                row.innerHTML = `
                    <td>${device.ip_address || 'N/A'}</td>
                    <td>${device.mac_address || 'N/A'}</td>
                    <td>${device.vendor || 'Unknown'}</td>
                    <td>${fingerprintHtml}</td>
                `;
            });
            
            // Populate Plugin Logs table
            data.plugin_logs.forEach(log => {
                const row = pluginLogsTable.insertRow();
                row.innerHTML = `
                    <td>${log.plugin_name}</td>
                    <td>${log.event}</td>
                    <td>${formatTimestamp(log.timestamp)}</td>
                `;
            });
            
            // Set up fingerprint toggle buttons
            setupFingerprintToggles();
            
            // Show success message with animation
            statusMessage.textContent = `Dashboard updated at ${new Date().toLocaleTimeString()}`;
            statusMessage.style.opacity = 1;
            
            setTimeout(() => {
                statusMessage.style.opacity = 0;
            }, 3000);
        }
        
        // Listen for dashboard data from the server
        socket.on('dashboard_data', (data) => {
            console.log(`[${new Date().toLocaleTimeString()}] Dashboard data received:`, data);
            updateDashboardData(data);
        });
        
        // Handle manual sync button click
        syncButton.addEventListener('click', () => {
            socket.emit('sync_dashboard');
            statusMessage.textContent = 'Syncing...';
            statusMessage.style.opacity = 1;
            syncButton.classList.add('syncing');
            
            setTimeout(() => {
                syncButton.classList.remove('syncing');
            }, 1000);
        });
        
        // Handle service restart button
        restartServiceButton.addEventListener('click', async () => {
            if (confirm('Are you sure you want to restart the Netfang service?')) {
                statusMessage.textContent = 'Restarting service...';
                statusMessage.style.opacity = 1;
                
                try {
                    const response = await fetch('/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        statusMessage.textContent = data.message;
                        // Show success notification
                        alertify.success(data.message, 5);
                    } else {
                        statusMessage.textContent = data.message;
                        // Show error notification
                        alertify.error(data.message, 5);
                    }
                } catch (error) {
                    statusMessage.textContent = `Error: ${error.message}`;
                    alertify.error(`Error restarting service: ${error.message}`, 5);
                }
                
                // Clear status message after 5 seconds
                setTimeout(() => {
                    statusMessage.style.opacity = 0;
                }, 5000);
            }
        });
        
        // Auto-refresh dashboard data every 30 seconds
        setInterval(() => {
            socket.emit('sync_dashboard');
        }, 30000);
    })();

    // Request initial dashboard data when connected
    document.addEventListener('DOMContentLoaded', function() {
        socket.emit('sync_dashboard');
    });
</script>
{% endblock %}
