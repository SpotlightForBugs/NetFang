{% extends "hidden/hidden_structure.html" %}

{% block title %}NetFang Analysis Dashboard{% endblock %}

{% block header_title %}Analysis Dashboard - {{ hostname }}{% endblock %}

{% block main_content %}
    <!-- Status Card -->
    <div class="status-card" id="statusContainer">
        <div class="status-card-header">
            <div class="status-info">
                <div class="status-icon" id="statusIcon">
                    <i class="fas fa-question-circle"></i> <!-- Default Icon -->
                </div>
                <div class="status-details">
                    <h3>System Status</h3>
                    <div class="status-label">Current Phase:</div>
                    <div class="status-value" id="state">{{ state }}</div>
                </div>
            </div>
            <div class="status-actions">
                <!-- Changed button ID and text -->
                <button id="restartNetfangButton" class="btn btn-outline-primary">
                    <i class="fas fa-power-off"></i> Restart Analyzer
                </button>
            </div>
        </div>
        <div class="status-card-body">
            <div class="scanning-indicator" id="scanningIndicator"> <!-- Keep for visual feedback -->
                <div class="scanning-pulse"></div>
                <span id="scanningIndicatorText">Working...</span>
            </div>
            <div class="progress status-progress">
                <div class="progress-bar" id="stateStatusProgress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="status-description" id="stateDescription">Initializing...</div>
        </div>
    </div>

    <!-- Dashboard Overview -->
    <div class="row g-3 mb-4">
        <!-- Scan Targets Card -->
        <div class="col-md-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-card-body">
                    <div class="metric-icon bg-primary-soft">
                        <i class="fas fa-bullseye"></i> <!-- Changed Icon -->
                    </div>
                    <div class="metric-data">
                        <h4 class="metric-title">Scan Targets</h4> <!-- Changed Title -->
                        <div class="metric-value" id="networksCount">-</div>
                        <div class="metric-trend">
                            <!-- Changed Labels -->
                            <span class="badge bg-success"><i class="fas fa-check"></i> Trusted: <span id="homeNetworkCount">-</span></span>
                            <span class="badge bg-danger"><i class="fas fa-skull-crossbones"></i> High-Risk: <span id="blacklistedNetworkCount">-</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discovered Hosts Card -->
        <div class="col-md-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-card-body">
                    <div class="metric-icon bg-success-soft">
                        <i class="fas fa-server"></i> <!-- Changed Icon -->
                    </div>
                    <div class="metric-data">
                        <h4 class="metric-title">Discovered Hosts</h4> <!-- Changed Title -->
                        <div class="metric-value" id="devicesCount">-</div>
                        <div class="metric-trend">
                            <span class="badge bg-info"><i class="fas fa-plug"></i> Active: <span id="connectedDeviceCount">-</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Events Card -->
        <div class="col-md-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-card-body">
                    <div class="metric-icon bg-warning-soft">
                        <i class="fas fa-tasks"></i> <!-- Changed Icon -->
                    </div>
                    <div class="metric-data">
                        <h4 class="metric-title">Analysis Events</h4> <!-- Changed Title -->
                        <div class="metric-value" id="activityCount">-</div>
                        <div class="metric-trend">
                            <span class="badge bg-info"><i class="fas fa-history"></i> Recent</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health Card (Optional) -->
        <div class="col-md-6 col-xl-3">
            <div class="metric-card">
                <div class="metric-card-body">
                    <div class="metric-icon bg-info-soft"> <!-- Changed Color -->
                        <i class="fas fa-heartbeat"></i> <!-- Changed Icon -->
                    </div>
                    <div class="metric-data">
                        <h4 class="metric-title">System Health</h4> <!-- Changed Title -->
                        <div class="metric-value" id="securityScore">-</div> <!-- Keep ID for JS -->
                        <div class="metric-trend">
                            <span class="badge bg-secondary" id="securityScoreTrend">Unknown</span> <!-- Changed Default -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity & Visualization Row -->
    <div class="row g-3 mb-4">
        <!-- Scan Event Timeline -->
        <div class="col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Scan Event Timeline</h5> <!-- Changed Title -->
                    <div class="card-actions">
                        <select id="timeRangeSelector" class="form-select form-select-sm">
                            <option value="day">Last 24 Hours</option>
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="activityChart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Host Status Distribution -->
        <div class="col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Host Status</h5> <!-- Changed Title -->
                </div>
                <div class="card-body">
                    <!-- Keep donut chart, labels will be updated in JS -->
                    <div id="securityDonut" class="chart-container chart-container-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header tab-header">
            <!-- Changed Tab Names -->
            <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="targets-tab" data-bs-toggle="tab" data-bs-target="#targets-content" type="button" role="tab">Targets</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hosts-tab" data-bs-toggle="tab" data-bs-target="#hosts-content" type="button" role="tab">Hosts</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-content" type="button" role="tab">Event Logs</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools-content" type="button" role="tab">Analysis Tools</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-content" type="button" role="tab">Active Tasks</button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="dashboardTabsContent">
                <!-- Targets Tab (Formerly Networks) -->
                <div class="tab-pane fade show active" id="targets-content" role="tabpanel" aria-labelledby="targets-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Observed Networks / Targets</h5> <!-- Changed Title -->
                        <div class="table-actions">
                            <div class="input-group input-group-sm table-search">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="networkSearchInput" placeholder="Search targets...">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <!-- Changed table ID and headers -->
                        <table class="table table-hover align-middle" id="targetsTable">
                            <thead>
                                <tr>
                                    <th>Identifier (MAC/SSID)</th>
                                    <th>Status</th>
                                    <th>Last Seen</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Hosts Tab (Formerly Devices) -->
                <div class="tab-pane fade" id="hosts-content" role="tabpanel" aria-labelledby="hosts-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Discovered Hosts</h5> <!-- Changed Title -->
                        <div class="table-actions">
                            <div class="input-group input-group-sm table-search">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="deviceSearchInput" placeholder="Search hosts...">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <!-- Changed table ID and headers -->
                        <table class="table table-hover align-middle" id="hostsTable">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>OS/Vendor Guess</th>
                                    <th>Target Network</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Event Logs Tab (Formerly Logs) -->
                <div class="tab-pane fade" id="logs-content" role="tabpanel" aria-labelledby="logs-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">System & Plugin Event Logs</h5> <!-- Changed Title -->
                        <div class="table-actions d-flex gap-2">
                            <button id="clearLogsButton" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-trash-alt"></i> Clear Display
                            </button>
                            <button id="autoScrollToggle" class="btn btn-sm btn-primary">
                                <i class="fas fa-scroll"></i> Auto-scroll: ON
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive log-table-container">
                        <!-- Changed table ID -->
                        <table class="table table-hover align-middle table-sm" id="eventLogsTable">
                            <thead>
                                <tr>
                                    <th>Source</th> <!-- Changed Header -->
                                    <th>Event Message</th> <!-- Changed Header -->
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Analysis Tools Tab (Formerly Actions) -->
                <div class="tab-pane fade" id="tools-content" role="tabpanel" aria-labelledby="tools-tab">
                    <div class="mb-3">
                        <h5 class="card-title">Available Analysis Tools (System-Wide)</h5> <!-- Changed Title -->
                    </div>
                    <!-- Changed container ID -->
                    <div class="actions-container" id="analysisToolsContainer">
                        <div class="no-actions-message text-center text-muted py-4">
                            <i class="fas fa-toolbox fa-2x mb-2"></i> <!-- Changed Icon -->
                            <p>No system-wide tools registered by plugins</p>
                        </div>
                        <!-- Tools will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Active Tasks Tab (Formerly Processes) -->
                <div class="tab-pane fade" id="tasks-content" role="tabpanel" aria-labelledby="tasks-tab">
                    <div class="mb-3">
                        <h5 class="card-title">Active Analysis Tasks</h5> <!-- Changed Title -->
                    </div>
                    <!-- Changed container ID -->
                    <div id="activeTasksContainer" class="processes-container">
                        <div class="no-processes-message text-center text-muted py-4">
                            <i class="fas fa-spinner fa-pulse fa-2x mb-2"></i> <!-- Changed Icon -->
                            <p>No analysis tasks currently running</p>
                        </div>
                        <!-- Task boxes will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    // socket is already established in the global scope (from hidden_structure.html)

    // --- Constants and State Variables ---
    const stateElement = document.getElementById("state");
    const scanningIndicator = document.getElementById("scanningIndicator");
    const scanningIndicatorText = document.getElementById("scanningIndicatorText");
    const statusContainer = document.getElementById("statusContainer");
    const statusIcon = document.getElementById("statusIcon");
    const stateStatusProgress = document.getElementById("stateStatusProgress");
    const stateDescription = document.getElementById("stateDescription");
    const restartNetfangButton = document.getElementById('restartNetfangButton'); // Updated ID
    let previousState = '{{ state }}'; // Initial state from Flask
    let currentIntervalID = null;

    // Dashboard data elements (IDs remain the same for simplicity, but represent new concepts)
    const networksCount = document.getElementById("networksCount"); // Represents Targets
    const devicesCount = document.getElementById("devicesCount");   // Represents Hosts
    const homeNetworkCount = document.getElementById("homeNetworkCount"); // Represents Trusted Targets
    const blacklistedNetworkCount = document.getElementById("blacklistedNetworkCount"); // Represents High-Risk Targets
    const connectedDeviceCount = document.getElementById("connectedDeviceCount"); // Represents Active Hosts
    const activityCount = document.getElementById("activityCount"); // Represents Events
    const securityScore = document.getElementById("securityScore"); // Represents System Health
    const securityScoreTrend = document.getElementById("securityScoreTrend");

    // Active Tasks display elements (Updated IDs)
    const activeTasksContainer = document.getElementById('activeTasksContainer');

    // Event Logs elements (Updated IDs)
    const eventLogsTable = document.getElementById('eventLogsTable').getElementsByTagName('tbody')[0];
    const clearLogsButton = document.getElementById('clearLogsButton');
    const autoScrollToggle = document.getElementById('autoScrollToggle');
    let autoScrollEnabled = true;

    // Targets and Hosts tables (Updated IDs)
    const targetsTable = document.getElementById('targetsTable').getElementsByTagName('tbody')[0];
    const hostsTable = document.getElementById('hostsTable').getElementsByTagName('tbody')[0];

    // Search inputs (IDs remain the same)
    const networkSearchInput = document.getElementById('networkSearchInput'); // Searches Targets
    const deviceSearchInput = document.getElementById('deviceSearchInput');   // Searches Hosts

    // Analysis Tools container (Updated ID)
    const analysisToolsContainer = document.getElementById('analysisToolsContainer');

    // Track registered actions (Tools)
    let registeredActions = {}; // Structure: { action_id: { action_id, plugin_name, action_name, description, target_type, command? } }

    // Map Target/Host IDs for action handling (IDs remain the same)
    let networkIdToMac = {}; // Maps Target ID -> MAC/Identifier
    let deviceIdToInfo = {}; // Maps Host ID -> { ip, mac, network_id }

    // Chart instances
    let activityChart = null;
    let securityDonut = null; // Represents Host Status

    // --- State Definitions and Handling ---

    // NEW State Definitions reflecting analysis phases
    const stateDefinitions = {
        'IDLE': {
            description: 'System idle. Ready to start analysis or monitoring.',
            icon: 'fas fa-power-off', color: 'text-secondary', progress: 10, score: 50, trend: 'Ready', trendClass: 'bg-secondary', indicatorText: 'Idle'
        },
        'INITIALIZING': {
            description: 'System initializing components and plugins...',
            icon: 'fas fa-cog fa-spin', color: 'text-info', progress: 25, score: 60, trend: 'Initializing', trendClass: 'bg-info', indicatorText: 'Initializing...'
        },
        'SCANNING_NETWORK': {
            description: 'Actively scanning the network for targets and hosts using configured tools (e.g., ARP, Nmap)...',
            icon: 'fas fa-crosshairs fa-spin', color: 'text-primary', progress: 50, score: 70, trend: 'Scanning', trendClass: 'bg-primary', indicatorText: 'Scanning Network...'
        },
        'ANALYZING_RESULTS': {
            description: 'Processing scan results, identifying services, OS, and potential vulnerabilities...',
            icon: 'fas fa-microscope', color: 'text-info', progress: 75, score: 80, trend: 'Analyzing', trendClass: 'bg-info', indicatorText: 'Analyzing Results...'
        },
        'MONITORING': {
            description: 'Passively monitoring network traffic and known hosts for changes or threats.',
            icon: 'fas fa-eye', color: 'text-success', progress: 100, score: 90, trend: 'Monitoring', trendClass: 'bg-success', indicatorText: 'Monitoring...'
        },
        'EXECUTING_ACTION': {
            description: 'Running a specific analysis tool or module...',
            icon: 'fas fa-terminal', color: 'text-warning', progress: 60, score: 75, trend: 'Executing', trendClass: 'bg-warning', indicatorText: 'Executing Task...'
        },
        'REPORTING': {
            description: 'Generating or updating analysis reports.',
            icon: 'fas fa-file-alt', color: 'text-success', progress: 100, score: 85, trend: 'Reporting', trendClass: 'bg-success', indicatorText: 'Reporting...'
        },
        'ERROR_STATE': {
            description: 'An error occurred. Check logs for details. System may be in an unstable state.',
            icon: 'fas fa-exclamation-triangle', color: 'text-danger', progress: 100, score: 10, trend: 'Error', trendClass: 'bg-danger', indicatorText: 'Error!'
        },
        'WAITING_FOR_NETWORK': { // Keep similar states for underlying network issues
            description: 'Waiting for a network interface to become available or configured.',
            icon: 'fas fa-plug', color: 'text-secondary', progress: 5, score: 20, trend: 'No Network', trendClass: 'bg-secondary', indicatorText: 'Waiting for Network...'
        },
        'NETWORK_DISCONNECTED': {
             description: 'Network connection lost. Analysis paused. Will resume when connection is restored.',
             icon: 'fas fa-unlink', color: 'text-danger', progress: 10, score: 15, trend: 'Disconnected', trendClass: 'bg-danger', indicatorText: 'Network Disconnected'
        },
        // Add more states as needed by your NetworkManager logic
        'UNKNOWN': {
            description: 'Current system state is unknown.',
            icon: 'fas fa-question-circle', color: 'text-secondary', progress: 0, score: 0, trend: 'Unknown', trendClass: 'bg-secondary', indicatorText: 'Unknown State'
        }
    };

    // Update the status card, progress bar, and container styling based on current state
    function updateStateIndicator(state) {
        const definition = stateDefinitions[state] || stateDefinitions['UNKNOWN'];

        // Remove previous state classes
        statusContainer.className = "status-card";
        // Add new state class (lowercase, hyphenated)
        statusContainer.classList.add(`state-${state.toLowerCase().replace(/_/g, '-')}`);

        // Update Icon
        statusIcon.innerHTML = `<i class="${definition.icon} ${definition.color}"></i>`;

        // Update Progress Bar
        stateStatusProgress.style.width = `${definition.progress}%`;
        stateStatusProgress.style.backgroundColor = ""; // Reset color (can be set via CSS)
        stateStatusProgress.style.animation = (state === 'SCANNING_NETWORK' || state === 'INITIALIZING' || state === 'EXECUTING_ACTION') ? "progressAnim 2s infinite" : "none";

        // Update Scanning Indicator visibility and text
        if (state === 'SCANNING_NETWORK' || state === 'ANALYZING_RESULTS' || state === 'EXECUTING_ACTION' || state === 'INITIALIZING') {
            scanningIndicator.classList.add('active');
            scanningIndicatorText.textContent = definition.indicatorText;
        } else {
            scanningIndicator.classList.remove('active');
        }

        // Update State Description
        stateDescription.textContent = definition.description;

        // Update "Security Score" / System Health
        animateValue(securityScore, parseInt(securityScore.textContent) || 0, definition.score, 1000);
        securityScoreTrend.innerHTML = `<i class="fas fa-chart-line"></i> ${definition.trend}`;
        securityScoreTrend.className = `badge ${definition.trendClass}`;

        // Update Host Status Donut Chart
        updateSecurityDonut(state); // Reuse function, update labels/data inside

        // Update Restart Button Style (e.g., make it red in ERROR_STATE)
        if (restartNetfangButton) {
            if (state === 'ERROR_STATE') {
                restartNetfangButton.className = "btn btn-danger";
                restartNetfangButton.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Force Restart`;
            } else {
                restartNetfangButton.className = "btn btn-outline-primary";
                restartNetfangButton.innerHTML = `<i class="fas fa-power-off"></i> Restart Analyzer`;
            }
        }

        // Handle Notifications based on state transitions
        handleStateNotifications(state, previousState);
    }

    function handleStateNotifications(newState, oldState) {
         // Dismiss previous non-error notifications
         if (newState !== 'ERROR_STATE' && newState !== 'NETWORK_DISCONNECTED') {
             alertify.dismissAll();
         }

         switch(newState) {
             case 'SCANNING_NETWORK':
                 if (oldState !== newState) alertify.notify('Starting network scan...', 'info', 5);
                 break;
             case 'ANALYZING_RESULTS':
                 if (oldState === 'SCANNING_NETWORK') alertify.success('Scan complete. Analyzing results...', 5);
                 break;
             case 'MONITORING':
                 if (oldState === 'ANALYZING_RESULTS' || oldState === 'INITIALIZING') alertify.success('System is now monitoring.', 3);
                 break;
             case 'ERROR_STATE':
                 // Persistent error notification
                 if (oldState !== newState) alertify.error('System entered ERROR state. Check logs!', 0);
                 break;
             case 'NETWORK_DISCONNECTED':
                 if (oldState !== newState) alertify.warning('Network disconnected. Analysis paused.', 10);
                 break;
             // Add more notifications as needed
         }
    }

    // Update Host Status donut chart
    function updateSecurityDonut(state) { // Renamed conceptually
        if (!securityDonut) return;

        // Example data - This should be driven by actual analysis results eventually
        let data = [0, 0, 0, 100]; // [Identified, Vulnerable, Exploited, Unknown/Offline]
        let labels = ['Identified', 'Vulnerable', 'Exploited', 'Unknown'];
        let colors = ['#0dcaf0', '#ffc107', '#dc3545', '#e0e0e0']; // Info, Warning, Danger, Gray

        // Adjust data based on state (Placeholder logic)
        switch(state) {
            case 'MONITORING':
            case 'REPORTING':
                // Simulate some results after analysis
                data = [60, 15, 5, 20];
                break;
            case 'ANALYZING_RESULTS':
                data = [70, 0, 0, 30]; // Mostly identified
                break;
            case 'SCANNING_NETWORK':
                data = [30, 0, 0, 70]; // Some identified
                break;
            case 'ERROR_STATE':
            case 'NETWORK_DISCONNECTED':
            case 'WAITING_FOR_NETWORK':
            case 'IDLE':
            default:
                data = [0, 0, 0, 100]; // All unknown/offline
                break;
        }

        securityDonut.updateOptions({
            series: data,
            labels: labels,
            colors: colors
        });
    }

    // Initialize Host Status donut chart
    function initializeSecurityDonut() { // Renamed conceptually
        const options = {
            series: [0, 0, 0, 100], // Initial: [Identified, Vulnerable, Exploited, Unknown]
            chart: {
                type: 'donut',
                height: 240,
                fontFamily: 'Inter, sans-serif',
            },
            colors: ['#0dcaf0', '#ffc107', '#dc3545', '#e0e0e0'], // Initial colors
            labels: ['Identified', 'Vulnerable', 'Exploited', 'Unknown'],
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%',
                        labels: { // Simplified labels for donut center
                            show: true,
                            name: { show: false },
                            value: { show: false }, // Hide individual value
                            total: {
                                show: true,
                                label: 'Total Hosts', // Changed label
                                formatter: function(w) {
                                    // Calculate total from series data
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    // Show total number of hosts (get from devicesCount)
                                    return devicesCount.textContent || '0';
                                }
                            }
                        }
                    }
                }
            },
            dataLabels: { enabled: false },
            legend: { position: 'bottom', offsetY: 0 },
            responsive: [{ /* ... responsive options ... */ }]
        };

        securityDonut = new ApexCharts(document.getElementById('securityDonut'), options);
        securityDonut.render();
    }

    // Initialize Scan Event Timeline chart (Activity Chart)
    function initializeActivityChart() { // Conceptually renamed
        // ... (Chart initialization code remains largely the same) ...
        // Consider changing colors or line style if desired
        const options = {
             series: [{ name: 'Scan Events', data: generateRandomData(24) }],
             // ... rest of the options from previous version ...
             colors: ['#6f42c1'], // Example: Purple color
             fill: {
                type: 'gradient',
                gradient: { shadeIntensity: 0.8, opacityFrom: 0.6, opacityTo: 0.1, stops: [0, 90, 100] }
            },
             // ... rest of the options ...
        };
        activityChart = new ApexCharts(document.getElementById('activityChart'), options);
        activityChart.render();
    }

    // --- Data Handling and UI Updates ---

    // Handle dashboard data sync (Targets, Hosts, Logs)
    function updateDashboardData(data) {
        // Update metrics counts (using new conceptual names)
        const targets = data.networks || []; // Use 'networks' data for Targets
        const hosts = data.devices || [];     // Use 'devices' data for Hosts
        const trustedTargets = targets.filter(n => n.is_home).length; // is_home -> Trusted
        const highRiskTargets = targets.filter(n => n.is_blacklisted).length; // is_blacklisted -> High-Risk

        animateValue(networksCount, parseInt(networksCount.textContent) || 0, targets.length, 500); // Targets count
        animateValue(devicesCount, parseInt(devicesCount.textContent) || 0, hosts.length, 500);     // Hosts count
        animateValue(homeNetworkCount, parseInt(homeNetworkCount.textContent) || 0, trustedTargets, 500); // Trusted count
        animateValue(blacklistedNetworkCount, parseInt(blacklistedNetworkCount.textContent) || 0, highRiskTargets, 500); // High-Risk count
        animateValue(connectedDeviceCount, parseInt(connectedDeviceCount.textContent) || 0, hosts.length, 500); // Active Hosts count (assuming all listed are active)
        // Update activity count based on logs or other event source if available
        animateValue(activityCount, parseInt(activityCount.textContent) || 0, (data.plugin_logs?.length || 0), 500); // Event count

        // Clear existing tables (using new IDs)
        targetsTable.innerHTML = '';
        hostsTable.innerHTML = '';

        // Reset ID mappings
        networkIdToMac = {};
        deviceIdToInfo = {};

        // Populate Targets table
        targets.forEach(target => {
            const row = targetsTable.insertRow();
            networkIdToMac[target.id] = target.mac_address; // Store mapping

            let statusClass = 'badge bg-secondary';
            let statusText = 'Observed';
            if (target.is_home) { // Trusted
                statusClass = 'badge bg-success'; statusText = 'Trusted'; row.classList.add('table-success');
            } else if (target.is_blacklisted) { // High-Risk
                statusClass = 'badge bg-danger'; statusText = 'High-Risk'; row.classList.add('table-danger');
            } else if (target.is_known) { // Known (optional concept)
                 statusClass = 'badge bg-info'; statusText = 'Known';
            }

            const actionButtons = getActionButtonsHtml('network', target.id); // Get actions for 'network' type

            row.innerHTML = `
                <td>${escapeHtml(target.mac_address)}</td> <!-- Assuming MAC is identifier -->
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>${formatTimestamp(target.last_seen)}</td>
                <td><div class="action-buttons d-flex flex-wrap gap-1">${actionButtons}</div></td>
            `;
        });

        // Populate Hosts table
        hosts.forEach(host => {
            const row = hostsTable.insertRow();
            deviceIdToInfo[host.id] = { ip: host.ip_address, mac: host.mac_address, network_id: host.network_id }; // Store mapping

            const hasFingerprintData = host.fingerprint && host.fingerprint !== 'None' && host.fingerprint.trim() !== '';
            const fingerprintHtml = hasFingerprintData ?
                `<button class="btn btn-sm btn-outline-info show-fingerprint" title="Show/Hide OS/Service Info">
                    <i class="fas fa-fingerprint"></i>
                 </button>
                 <div class="fingerprint-data small bg-light p-2 mt-1 rounded" style="display: none; white-space: pre-wrap; word-break: break-all;">${escapeHtml(host.fingerprint)}</div>` : '';

            const actionButtons = getActionButtonsHtml('device', host.id); // Get actions for 'device' type

            const targetInfo = host.network_id && networkIdToMac[host.network_id] ?
                `${escapeHtml(networkIdToMac[host.network_id])}` : 'Unknown';

            // Use Vendor as OS/Vendor Guess
            const vendorBadge = host.vendor ?
                `<span class="badge bg-light text-dark">${escapeHtml(host.vendor)}</span>` :
                '<span class="badge bg-secondary">Unknown</span>';

            row.innerHTML = `
                <td>${escapeHtml(host.ip_address) || 'N/A'}</td>
                <td>${escapeHtml(host.mac_address) || 'N/A'}</td>
                <td>${vendorBadge}</td>
                <td><span class="text-muted small">${targetInfo}</span></td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div>${fingerprintHtml}</div>
                        <div class="action-buttons d-flex flex-wrap gap-1">${actionButtons}</div>
                    </div>
                </td>
            `;
        });

        // Populate Event Logs table (using new ID)
        if (data.plugin_logs && data.plugin_logs.length > 0) {
            // Only clear/repopulate fully on large updates (heuristic)
            if (data.plugin_logs.length > 10) {
                 eventLogsTable.innerHTML = '';
                 data.plugin_logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                     .forEach(log => addEventLog(log, false)); // Add without animation
                 if (autoScrollEnabled) {
                     eventLogsTable.closest('.log-table-container').scrollTop = 0;
                 }
            }
            // Individual logs are added via 'plugin_log' event
        }

        // Update registered actions/tools if provided in sync data
        if (data.registered_actions) {
             const currentActionKeys = Object.keys(registeredActions);
             const newActionKeys = Object.keys(data.registered_actions);
             if (currentActionKeys.length !== newActionKeys.length || !currentActionKeys.every(key => newActionKeys.includes(key))) {
                 console.log("Updating registered tools from dashboard data.");
                 registeredActions = data.registered_actions;
                 updateAnalysisToolsPanel(); // Update the Tools tab
             }
        }


        // Re-bind event listeners after updating tables
        setupFingerprintToggles();
        setupActionButtons(); // Re-bind actions in tables/tools panel

        // alertify.success(`Dashboard updated at ${new Date().toLocaleTimeString()}`, 2); // Optional notification
    }

    // Generate HTML for action buttons (Tools)
    function getActionButtonsHtml(targetType, targetId) {
        let actionButtons = [];
        Object.values(registeredActions).forEach(action => {
            // Action's target_type should match the context ('network' for targets, 'device' for hosts)
            if (action.target_type === targetType) {
                actionButtons.push(`
                    <button
                        class="btn btn-sm btn-outline-primary plugin-action-button"
                        data-action-id="${action.action_id}"
                        data-target-id="${targetId}"
                        title="${escapeHtml(action.description || action.action_name)}"
                    >
                        <i class="fas fa-play small me-1"></i> ${escapeHtml(action.action_name)}
                    </button>
                `);
            }
        });
        return actionButtons.join('');
    }

    // Update the Analysis Tools panel (System-wide tools)
    function updateAnalysisToolsPanel() {
        analysisToolsContainer.innerHTML = ''; // Clear current tools

        const systemActions = Object.values(registeredActions).filter(
            action => action.target_type === 'system'
        );

        if (systemActions.length === 0) {
            analysisToolsContainer.innerHTML = `
                <div class="no-actions-message text-center text-muted py-4">
                    <i class="fas fa-toolbox fa-2x mb-2"></i>
                    <p>No system-wide tools registered by plugins</p>
                </div>`;
            return;
        }

        // Group tools by plugin
        const toolsByPlugin = {};
        systemActions.forEach(action => {
            if (!toolsByPlugin[action.plugin_name]) toolsByPlugin[action.plugin_name] = [];
            toolsByPlugin[action.plugin_name].push(action);
        });

        const toolsContainer = document.createElement('div');
        toolsContainer.className = 'row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3';

        Object.entries(toolsByPlugin).forEach(([pluginName, actions]) => {
            const card = document.createElement('div');
            card.className = 'col';
            card.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h6 class="card-title mb-0 fw-bold">${escapeHtml(pluginName)}</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            ${actions.map(action => `
                                <button
                                    class="btn btn-primary plugin-action-button text-start"
                                    data-action-id="${action.action_id}"
                                    data-target-id="system"
                                    title="${escapeHtml(action.description || action.action_name)}"
                                >
                                   <i class="fas fa-wrench me-2"></i> ${escapeHtml(action.action_name)}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            toolsContainer.appendChild(card);
        });

        analysisToolsContainer.appendChild(toolsContainer);
        setupActionButtons(); // Re-bind listeners
    }

    // --- Event Log Handling ---

    // Add event log to the table (using new ID)
    function addEventLog(log, animate = true) {
        const row = eventLogsTable.insertRow(0);
        row.innerHTML = `
            <td><span class="badge bg-secondary">${escapeHtml(log.plugin_name || 'System')}</span></td>
            <td>${escapeHtml(log.event || log.message || '')}</td>
            <td><span class="text-muted small">${formatTimestamp(log.timestamp)}</span></td>
        `;

        if (animate) {
            row.classList.add('new-log-entry');
            setTimeout(() => row.classList.remove('new-log-entry'), 2000);
            if (autoScrollEnabled) {
                const scrollContainer = eventLogsTable.closest('.log-table-container');
                if (scrollContainer && scrollContainer.scrollTop < 50) {
                     scrollContainer.scrollTop = 0;
                }
            }
        }

        // Limit table size
        const MAX_LOG_ROWS = 500;
        if (eventLogsTable.rows.length > MAX_LOG_ROWS) {
            eventLogsTable.deleteRow(eventLogsTable.rows.length - 1);
        }
    }

    // --- Active Task (Process) Handling ---

    // Handle command output streaming for tasks
    function handleCommandOutput(data) {
        const processId = data.process_id;
        let taskCard = document.getElementById(`task-${processId}`); // Use task- ID prefix

        const noTasksMessage = activeTasksContainer.querySelector('.no-processes-message');
        if (noTasksMessage) noTasksMessage.remove();

        if (!taskCard) {
            taskCard = document.createElement('div');
            taskCard.id = `task-${processId}`;
            taskCard.className = 'card process-card mb-3 shadow-sm'; // Keep process-card class for styling
            taskCard.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-tasks me-2"></i> <!-- Task Icon -->
                        Task <span class="badge bg-info ms-1">${escapeHtml(data.plugin_name)}</span>
                        <small class="text-muted ms-2">ID: ${processId.substring(0, 8)}...</small>
                    </h6>
                    <button type="button" class="btn-close btn-sm" aria-label="Close" onclick="closeTask('${processId}')"></button>
                </div>
                <div class="card-body p-0">
                    <div class="command-line bg-dark text-light p-2 small">
                        <code>$ ${escapeHtml(data.command)}</code>
                    </div>
                    <div class="process-output p-2" id="output-${processId}" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8em; background-color: #f8f9fa;"></div>
                </div>
            `;
            activeTasksContainer.prepend(taskCard); // Add new tasks at the top
        }

        const outputContainer = document.getElementById(`output-${processId}`);
        if (outputContainer) {
            const outputLine = document.createElement('div');
            // Add stream indicator (stdout/stderr) if needed
            // outputLine.className = data.stream === 'stderr' ? 'text-danger' : '';
            outputLine.textContent = data.output;
            outputContainer.appendChild(outputLine);
            outputContainer.scrollTop = outputContainer.scrollHeight; // Auto-scroll

            if (data.is_complete) {
                const completionLine = document.createElement('div');
                const exitStatus = data.exit_code === 0 ? 'successfully' : `with error code ${data.exit_code}`;
                completionLine.className = `completion-line text-muted small mt-2 border-top pt-1 ${data.exit_code !== 0 ? 'text-danger fw-bold' : 'text-success'}`;
                completionLine.textContent = `--- Task finished ${exitStatus} ---`;
                outputContainer.appendChild(completionLine);
                // Maybe change card border or header color on completion/error
                taskCard.querySelector('.card-header').classList.add(data.exit_code === 0 ? 'bg-success-soft' : 'bg-danger-soft');
            }
        }
    }

    // Handle new task start event
    function handleCurrentProcess(data) { // Keep function name, but treat as task start
        if (data === null || !data.process_id) return; // Ignore null updates for now

        const processId = data.process_id;
        let taskCard = document.getElementById(`task-${processId}`);

        const noTasksMessage = activeTasksContainer.querySelector('.no-processes-message');
        if (noTasksMessage) noTasksMessage.remove();

        if (!taskCard) {
             taskCard = document.createElement('div');
             taskCard.id = `task-${processId}`;
             taskCard.className = 'card process-card mb-3 shadow-sm';
             taskCard.innerHTML = `
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h6 class="mb-0 fw-bold">
                        <i class="fas fa-tasks me-2"></i>
                        Task <span class="badge bg-info ms-1">${escapeHtml(data.plugin_name)}</span>
                        <small class="text-muted ms-2">ID: ${processId.substring(0, 8)}...</small>
                    </h6>
                    <button type="button" class="btn-close btn-sm" aria-label="Close" onclick="closeTask('${processId}')"></button>
                </div>
                <div class="card-body p-0">
                    <div class="command-line bg-dark text-light p-2 small">
                        <code>$ ${escapeHtml(data.command)}</code>
                    </div>
                    <div class="process-output p-2" id="output-${processId}" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8em; background-color: #f8f9fa;"></div>
                </div>
            `;
            activeTasksContainer.prepend(taskCard);
        }

        const outputContainer = document.getElementById(`output-${processId}`);
        if (outputContainer) {
            const startLine = document.createElement('div');
            startLine.className = 'start-line text-muted small mb-1 border-bottom pb-1';
            // Use JS Date for formatting start time if available
            const startTime = data.start_time ? formatTimestamp(new Date(data.start_time * 1000)) : 'N/A'; // Assuming start_time is epoch seconds
            startLine.textContent = `Task started at ${startTime}`;
            outputContainer.innerHTML = ''; // Clear previous output
            outputContainer.appendChild(startLine);
        }
    }

    // Close a specific task card
    window.closeTask = function(processId) { // Renamed function
        const taskCard = document.getElementById(`task-${processId}`);
        if (taskCard) {
            taskCard.remove();
            if (activeTasksContainer.children.length === 0) {
                activeTasksContainer.innerHTML = `
                    <div class="no-processes-message text-center text-muted py-4">
                        <i class="fas fa-spinner fa-pulse fa-2x mb-2"></i>
                        <p>No analysis tasks currently running</p>
                    </div>`;
            }
        }
    }

    // --- Utility Functions ---
    // animateValue, formatTimestamp, escapeHtml (remain the same)
    // typeText (remains the same)
    // setupFingerprintToggles (remains the same, acts on hostsTable)
    // setupActionButtons (remains the same, acts on targetsTable, hostsTable, analysisToolsContainer)
    // setupTableFilters (remains the same, acts on networkSearchInput, deviceSearchInput)

    // --- Socket Event Listeners ---
    socket.on("state_update", (data) => {
        console.log(`State update: ${data.state}`);
        const newState = data.state || 'UNKNOWN';
        if (newState !== previousState) {
            typeText(stateElement, newState.replace(/_/g, ' '));
            updateStateIndicator(newState);
            previousState = newState;
        }
    });

    socket.on('dashboard_data', (data) => {
        console.log("Dashboard data received.");
        updateDashboardData(data);
        // Sync state from dashboard data if needed
        if (data.state && data.state !== previousState) {
             console.log(`Syncing state from dashboard data: ${data.state}`);
             typeText(stateElement, data.state.replace(/_/g, ' '));
             updateStateIndicator(data.state);
             previousState = data.state;
        }
    });

    socket.on('plugin_log', (log) => { // Use for Event Logs
        addEventLog(log);
    });

    socket.on('command_output', (data) => { // Use for Task output
        handleCommandOutput(data);
    });

    socket.on('current_process', (data) => { // Use for Task start
        handleCurrentProcess(data);
    });

    socket.on('register_action', (action) => { // Use for Tool registration
        console.log(`Tool registered: ${action.action_name}`);
        registeredActions[action.action_id] = action;
        updateAnalysisToolsPanel(); // Update Tools tab
        // Request sync to update action buttons in tables
        syncDashboard();
        alertify.notify(`New tool available: ${escapeHtml(action.action_name)}`, 'info', 5);
    });

     socket.on('registered_actions', (actions) => { // Handle initial list of actions on connect
        console.log("Received initial list of registered tools.");
        registeredActions = actions || {};
        updateAnalysisToolsPanel();
        // No need to sync here, dashboard_data will follow if requested
    });

    socket.on('alert_sync', (data) => { // Use for system alerts
        console.log(`Alert: ${data.level} - ${data.message}`);
        const message = escapeHtml(data.message);
        const duration = (data.level === 'ERROR' || data.level === 'CRITICAL') ? 0 : (data.level === 'WARNING' ? 10 : 5);
        switch(data.level) {
            case 'ERROR':
            case 'CRITICAL': alertify.error(message, duration); break;
            case 'WARNING': alertify.warning(message, duration); break;
            case 'INFO': alertify.message(message, duration); break; // Use message for info
            case 'SUCCESS': alertify.success(message, duration); break;
        }
    });

    // Handle socket connection events
    socket.on('connect', () => {
        console.log("Socket connected.");
        alertify.success('Real-time connection established.', 2);
        syncDashboard(); // Request initial data
    });
    socket.on('disconnect', (reason) => {
        console.warn(`Socket disconnected: ${reason}`);
        alertify.error('Real-time connection lost. Attempting to reconnect...', 0);
        updateStateIndicator('NETWORK_DISCONNECTED'); // Reflect disconnected state in UI
    });
    socket.on('connect_error', (error) => {
        console.error(`Socket connection error: ${error}`);
    });


    // --- Initialization and Global Functions ---

    // Sync dashboard function
    window.syncDashboard = function() {
        console.log("Requesting dashboard sync...");
        socket.emit('sync_dashboard');
        const syncButton = document.getElementById('syncButton'); // In hidden_structure.html
        if (syncButton && !syncButton.disabled) {
            const originalHtml = syncButton.innerHTML;
            syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            syncButton.disabled = true;
            setTimeout(() => {
                syncButton.innerHTML = originalHtml;
                syncButton.disabled = false;
            }, 2000);
        }
        alertify.notify('Syncing dashboard data...', 'info', 2);
    };

    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Set initial state display
        stateElement.textContent = previousState.replace(/_/g, ' ');
        updateStateIndicator(previousState);

        // Initialize charts
        initializeActivityChart();
        initializeSecurityDonut();

        // Setup table filters
        setupTableFilters();

        // Setup action button delegation (covers tables and tools panel)
        setupActionButtons();

        // Setup fingerprint toggle delegation
        setupFingerprintToggles();

        // Clear logs display handler
        clearLogsButton.addEventListener('click', () => {
            eventLogsTable.innerHTML = '';
            alertify.message('Log display cleared', 2);
        });

        // Auto-scroll toggle handler
        autoScrollToggle.addEventListener('click', () => {
            autoScrollEnabled = !autoScrollEnabled;
            const scrollContainer = eventLogsTable.closest('.log-table-container');
            if (autoScrollEnabled) {
                autoScrollToggle.innerHTML = '<i class="fas fa-scroll"></i> Auto-scroll: ON';
                autoScrollToggle.classList.replace('btn-outline-secondary', 'btn-primary');
                alertify.success('Log auto-scroll enabled', 2);
                if (scrollContainer) scrollContainer.scrollTop = 0;
            } else {
                autoScrollToggle.innerHTML = '<i class="fas fa-scroll"></i> Auto-scroll: OFF';
                autoScrollToggle.classList.replace('btn-primary', 'btn-outline-secondary');
                alertify.message('Log auto-scroll disabled', 2);
            }
        });

        // Restart Analyzer button handler (Updated ID)
        if (restartNetfangButton) {
            restartNetfangButton.addEventListener('click', () => {
                alertify.confirm(
                    'Restart Analyzer',
                    'Are you sure you want to restart the NetFang analysis service?',
                    () => { // On confirm
                        console.log('Requesting service restart...');
                        const originalHtml = restartNetfangButton.innerHTML;
                        restartNetfangButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restarting...';
                        restartNetfangButton.disabled = true;

                        // Call the new API endpoint
                        fetch('/service/restart', { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                restartNetfangButton.innerHTML = originalHtml; // Reset button always
                                restartNetfangButton.disabled = false;
                                if (data.status === 'success') {
                                    alertify.success(data.message || 'Service restart initiated.');
                                } else {
                                    alertify.error(data.message || 'Failed to initiate restart.');
                                }
                            })
                            .catch(error => {
                                restartNetfangButton.innerHTML = originalHtml;
                                restartNetfangButton.disabled = false;
                                alertify.error(`Error sending restart request: ${error}`);
                            });
                    },
                    () => alertify.error('Restart cancelled') // On cancel
                ).set('labels', {ok:'Restart', cancel:'Cancel'});
            });
        }

        // Initial dashboard data load
        if (socket.connected) {
            syncDashboard();
        } else {
            console.log("Waiting for socket connection...");
        }

        console.log("Analysis Dashboard Initialized");
    });

</script>
{% endblock %}
