<!DOCTYPE html>
<html lang="{{ 'de' if request.accept_languages.best_match(['de','en'])=='de' else 'en' }}">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>{% block title %}NetFang{% endblock %}</title>

    <!-- Google Fonts - Added Hack for console styling -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Roboto+Mono:wght@400;500&family=Hack:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS (with custom styling overrides) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Include Socket.IO client library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
            integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- AlertifyJS CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
    <!-- AlertifyJS JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hidden.css') }}">
    
    {% block additional_head %}{% endblock %}
</head>
<body class="pentest-theme">
    <header>
        <div class="header-content">
            <!-- NetFang Logo + Title left-aligned -->
            <div class="d-flex align-items-center">
                <img src="{{ url_for('static', filename='router_logo.png') }}" alt="NetFang Logo" class="netfang-logo"/>
                <div class="title-container">
                    <h1>{% block header_title %}NetFang Security Scanner{% endblock %}</h1>
                    <div class="subtitle">Network Reconnaissance & Penetration Testing Platform</div>
                </div>
            </div>

            <!-- Right side controls -->
            <div class="d-flex align-items-center">
                <!-- System stats -->
                <div class="system-stats me-3">
                    <span class="stat-item"><i class="fas fa-microchip"></i> <span id="cpuStat">--</span></span>
                    <span class="stat-item"><i class="fas fa-memory"></i> <span id="memStat">--</span></span>
                    <span class="stat-item"><i class="fas fa-thermometer-half"></i> <span id="tempStat">--</span></span>
                </div>
                
                <!-- Logout button -->
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm logout-btn me-3">
                    <i class="fas fa-sign-out-alt"></i> 
                    {{ 'Abmelden' if request.accept_languages.best_match(['de','en'])=='de' else 'Logout' }}
                </a>
                
                <!-- Connection status badge -->
                <span id="connectionBadge" class="badge disconnected">Disconnected</span>
            </div>
        </div>
    </header>

    <main>
        {% block main_content %}{% endblock %}
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <p>NetFang &copy; 2025 | <span class="version-label">Version 2.5.1</span></p>
            </div>
            <div class="footer-right">
                <p>{{ 'Ausführungsmodus: Getarnt als Router' if request.accept_languages.best_match(['de','en'])=='de' else 'Execution Mode: Router Disguise Active' }}</p>
            </div>
        </div>
    </footer>

    <!-- Alert Panel -->
    {% block alerts_panel %}
    <div id="alertPanel">
        <div id="alertPanelHeader">
            <h3><i class="fas fa-bell me-2"></i>Security Notifications <span class="notification-dot" id="newAlertDot"></span></h3>
            <span id="alertCounter">0</span>
        </div>
        <ul id="alertList"></ul>
        <div id="alertControls">
            <button class="alert-filter active" data-filter="all">All</button>
            <button class="alert-filter" data-filter="active">Active</button>
            <button class="alert-filter" data-filter="info">Info</button>
            <button class="alert-filter" data-filter="warning">Warning</button>
            <button class="alert-filter" data-filter="critical">Critical</button>
        </div>
    </div>
    {% endblock %}

    <!-- Command Palette -->
    <div id="commandPalette" class="command-palette">
        <div class="command-palette-header">
            <h3><i class="fas fa-terminal me-2"></i>Command Palette</h3>
            <button id="closeCommandPalette" class="close-button">×</button>
        </div>
        <div class="command-input-container">
            <span class="command-prompt">$</span>
            <input type="text" id="commandInput" class="command-input" placeholder="Type a command (e.g., nmap -sV 192.168.1.1)" />
        </div>
        <div class="command-suggestions">
            <div class="suggestion-category">
                <h4>Recent Commands</h4>
                <ul id="recentCommands" class="suggestion-list"></ul>
            </div>
            <div class="suggestion-category">
                <h4>Quick Actions</h4>
                <ul id="quickActions" class="suggestion-list">
                    <li data-command="nmap -sV -sC --script=vuln -oN scan_results.txt [IP]">Vulnerability Scan</li>
                    <li data-command="sudo arp-scan --localnet">ARP Network Scan</li>
                    <li data-command="sudo tcpdump -i [INTERFACE] -w capture.pcap">Packet Capture</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Common Socket.IO and Alerts Setup -->
    <script>
        const socket = io({
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        
        // Translations for the badge
        const connectedText = "{{ 'Verbunden mit NetFang' if request.accept_languages.best_match(['de','en'])=='de' else 'Connected' }}";
        const disconnectedText = "{{ 'Verbindung getrennt' if request.accept_languages.best_match(['de','en'])=='de' else 'Disconnected' }}";
        
        // Connect status badge
        const connectionBadge = document.getElementById('connectionBadge');
        
        // Handle connection
        socket.on('connect', function() {
            connectionBadge.textContent = connectedText;
            connectionBadge.className = 'badge connected';
            console.log('Socket.IO connection established');
            
            // Request system stats on connect
            socket.emit('request_system_stats');
        });
        
        // Handle disconnection
        socket.on('disconnect', function() {
            connectionBadge.textContent = disconnectedText;
            connectionBadge.className = 'badge disconnected';
            console.log('Socket.IO connection lost');
        });
        
        // Handle reconnect attempt
        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log(`Socket.IO reconnection attempt ${attemptNumber}`);
            connectionBadge.textContent = `Reconnecting (${attemptNumber})`;
            connectionBadge.className = 'badge reconnecting';
        });
        
        // Handle successful reconnect
        socket.on('reconnect', function(attemptNumber) {
            console.log(`Socket.IO reconnected after ${attemptNumber} attempts`);
            connectionBadge.textContent = connectedText;
            connectionBadge.className = 'badge connected';
            
            // Re-sync data after reconnect
            if (window.syncDashboard) {
                window.syncDashboard();
            }
        });
        
        // System stats update
        socket.on('system_stats', function(data) {
            document.getElementById('cpuStat').textContent = data.cpu + '%';
            document.getElementById('memStat').textContent = data.memory + '%';
            document.getElementById('tempStat').textContent = data.temperature + '°C';
        });
        
        // Handle alerts
        const alertPanel = document.getElementById('alertPanel');
        const alertList = document.getElementById('alertList');
        const alertCounter = document.getElementById('alertCounter');
        const newAlertDot = document.getElementById('newAlertDot');
        let alertCount = 0;
        
        // Listen for alert events
        socket.on('alert', function(data) {
            // Increment counter
            alertCount++;
            alertCounter.textContent = alertCount;
            
            // Show notification dot
            newAlertDot.style.display = 'inline-block';
            
            // Create alert item
            const alertItem = document.createElement('li');
            alertItem.className = `alert-item alert-${data.level.toLowerCase()}`;
            
            // Format timestamp
            const timestamp = new Date(data.timestamp);
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Add appropriate icon based on level
            let iconClass = 'fa-info-circle';
            if (data.level === 'WARNING') iconClass = 'fa-exclamation-triangle';
            if (data.level === 'ERROR' || data.level === 'CRITICAL') iconClass = 'fa-exclamation-circle';
            if (data.level === 'SUCCESS') iconClass = 'fa-check-circle';
            
            // Set alert HTML
            alertItem.innerHTML = `
                <div class="alert-header">
                    <span class="alert-title"><i class="fas ${iconClass} me-2"></i>${data.title}</span>
                    <span class="alert-timestamp">${formattedTime}</span>
                </div>
                <div class="alert-content">${data.message}</div>
            `;
            
            // Add to list
            alertList.prepend(alertItem);
            
            // Show panel if this is first alert
            if (alertCount === 1) {
                setTimeout(() => {
                    alertPanel.classList.add('active');
                }, 500);
            }
        });
        
        // Toggle alert panel visibility when clicking counter
        alertCounter.addEventListener('click', function() {
            alertPanel.classList.toggle('active');
            // Hide notification dot when panel is opened
            if (alertPanel.classList.contains('active')) {
                newAlertDot.style.display = 'none';
            }
        });
        
        // Filter alerts
        document.querySelectorAll('.alert-filter').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('.alert-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get filter value
                const filter = this.dataset.filter;
                
                // Apply filter
                document.querySelectorAll('.alert-item').forEach(item => {
                    if (filter === 'all') {
                        item.style.display = 'block';
                    } else if (filter === 'active') {
                        const isInfo = item.classList.contains('alert-info');
                        item.style.display = isInfo ? 'none' : 'block';
                    } else {
                        const hasClass = item.classList.contains(`alert-${filter}`);
                        item.style.display = hasClass ? 'block' : 'none';
                    }
                });
            });
        });
        
        // Command Palette Functionality
        const commandPalette = document.getElementById('commandPalette');
        const commandInput = document.getElementById('commandInput');
        let recentCommands = [];
        
        // Handle keyboard shortcut (Ctrl+Shift+P) to open command palette
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                commandPalette.classList.toggle('active');
                if (commandPalette.classList.contains('active')) {
                    commandInput.focus();
                }
            }
        });
        
        // Close command palette button
        document.getElementById('closeCommandPalette').addEventListener('click', function() {
            commandPalette.classList.remove('active');
        });
        
        // Handle command input
        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const command = commandInput.value.trim();
                
                if (command) {
                    // Add to recent commands (avoid duplicates)
                    if (!recentCommands.includes(command)) {
                        recentCommands.unshift(command);
                        if (recentCommands.length > 5) {
                            recentCommands.pop();
                        }
                        updateRecentCommands();
                    }
                    
                    // Execute command
                    socket.emit('execute_command', { command: command });
                    commandInput.value = '';
                    
                    // Close command palette
                    commandPalette.classList.remove('active');
                    
                    // Show notification
                    alertify.success(`Executing: ${command}`);
                }
            }
        });
        
        // Update recent commands list
        function updateRecentCommands() {
            const recentCommandsList = document.getElementById('recentCommands');
            recentCommandsList.innerHTML = '';
            
            recentCommands.forEach(cmd => {
                const li = document.createElement('li');
                li.textContent = cmd;
                li.dataset.command = cmd;
                li.addEventListener('click', function() {
                    commandInput.value = this.dataset.command;
                    commandInput.focus();
                });
                recentCommandsList.appendChild(li);
            });
        }
        
        // Quick action click handler
        document.querySelectorAll('#quickActions li').forEach(item => {
            item.addEventListener('click', function() {
                commandInput.value = this.dataset.command;
                commandInput.focus();
            });
        });
        
        // Request system stats every 10 seconds
        setInterval(() => {
            if (socket.connected) {
                socket.emit('request_system_stats');
            }
        }, 10000);
    </script>
    
    {% block additional_scripts %}{% endblock %}
</body>
</html>